name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"

jobs:
  # Security and Secrets Scanning
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Detect secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  # Code Quality and Linting
  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy safety bandit
          pip install -r requirements.txt
          if [ -f ai-backend/requirements.txt ]; then pip install -r ai-backend/requirements.txt; fi

      - name: Run Black (code formatting)
        run: black --check --diff .

      - name: Run isort (import sorting)
        run: isort --check-only --diff .

      - name: Run flake8 (linting)
        run: flake8 --max-line-length=88 --extend-ignore=E203,W503 .

      - name: Run mypy (type checking)
        run: mypy ai-backend/ --ignore-missing-imports || true

      - name: Run bandit (security linter)
        run: bandit -r ai-backend/ -f json -o bandit-report.json || true

      - name: Check for hardcoded secrets
        run: |
          # Check for common secret patterns
          if grep -r -i "sk-\|password\|secret\|token\|api_key" --include="*.py" --include="*.yml" --include="*.yaml" --include="*.json" --exclude-dir=.git --exclude-dir=venv .; then
            echo "âŒ Potential secrets found in code!"
            exit 1
          else
            echo "âœ… No obvious secrets detected"
          fi

  # Python Testing
  python-tests:
    name: ğŸ§ª Python Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio
          pip install -r requirements.txt
          if [ -f ai-backend/requirements.txt ]; then pip install -r ai-backend/requirements.txt; fi

      - name: Run tests
        run: |
          pytest --cov=ai-backend --cov-report=xml --cov-report=html -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # MkDocs Build and Validation
  docs-validation:
    name: ğŸ“š Documentation Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install MkDocs and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate MkDocs configuration
        run: mkdocs --config-file mkdocs.yml --quiet --strict build

      - name: Check for broken links
        run: |
          pip install markdown-link-check
          find docs/ -name "*.md" -exec markdown-link-check {} \; || true

      - name: Build documentation
        run: mkdocs build --strict

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: docs-build
          path: site/

  # Docker Build and Security
  docker-validation:
    name: ğŸ³ Docker Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: |
          docker-compose -f docker/docker-compose.yml build

      - name: Run Docker security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'homelab-docs_mkdocs:latest'
          format: 'sarif'
          output: 'docker-trivy-results.sarif'

      - name: Upload Docker scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'docker-trivy-results.sarif'

  # Integration Tests
  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [python-tests, docs-validation]
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r ai-backend/requirements.txt
          pip install requests pytest pytest-asyncio

      - name: Start services with Docker Compose
        run: |
          docker-compose -f docker/docker-compose.yml up -d
          sleep 30  # Wait for services to be ready

      - name: Run integration tests
        run: |
          # Test API endpoints
          curl -f http://localhost:8001/health || echo "API health check failed"
          curl -f http://localhost:8000 || echo "MkDocs health check failed"
          
          # Run Python integration tests if they exist
          if [ -d tests ]; then
            pytest tests/integration/ -v || true
          fi

      - name: Cleanup
        if: always()
        run: |
          docker-compose -f docker/docker-compose.yml down -v

  # Deployment (only on releases)
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality, python-tests, docs-validation, docker-validation, integration-tests]
    if: github.event_name == 'release' && github.event.action == 'published'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker images
        run: |
          docker-compose -f docker/docker-compose.yml build
          docker-compose -f docker/docker-compose.yml push

      - name: Deploy documentation to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          cname: homelab-docs.github.io

      - name: Notify deployment status
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()

  # Performance and Load Testing
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Artillery
        run: npm install -g artillery

      - name: Start services
        run: |
          docker-compose -f docker/docker-compose.yml up -d
          sleep 60  # Wait for services to be ready

      - name: Run load tests
        run: |
          # Create a simple load test
          cat > load-test.yml << 'EOF'
          config:
            target: 'http://localhost:8000'
            phases:
              - duration: 60
                arrivalRate: 5
          scenarios:
            - name: "Load test MkDocs"
              weight: 70
              flow:
                - get:
                    url: "/"
            - name: "Load test API"
              weight: 30
              flow:
                - get:
                    url: "http://localhost:8001/health"
          EOF
          
          artillery run load-test.yml || echo "Load test completed with issues"

      - name: Cleanup
        if: always()
        run: |
          docker-compose -f docker/docker-compose.yml down -v
